<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pac-Man+</title>

  <link rel="stylesheet" href="https://thereelsho.github.io/10in1arcade/arcade.css">

  <style>
    body { background:#000; color:#fff; text-align:center; font-family:Arial; margin:0; padding:10px }
    canvas { background:#111; display:block; margin:10px auto; border:2px solid #555; image-rendering: pixelated; }
    .hud { margin:6px 0; font-family: 'Press Start 2P', system-ui, Arial, sans-serif; font-size: 12px; }
    .overlay {
      position: absolute; left:0; right:0; margin:auto; width:100%; text-align:center;
      pointer-events:none; font-family:'Press Start 2P', system-ui, Arial, sans-serif;
    }
    .overlay .msg {
      display:inline-block; padding:8px 14px; border:2px solid #ff2d75; border-radius:8px;
      color:#ff2d75; text-shadow:0 0 6px #ff2d75; background:#000a; margin-top:8px;
    }
    .stage { position: relative; width: fit-content; margin: 0 auto; }
    .back-btn { display:block; margin-top:14px; color:#ff2d75; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Pac-Man+</h1>
  <div class="hud">
    Score: <span id="score">0</span> ·
    High: <span id="high">0</span> ·
    Lives: <span id="lives">3</span>
  </div>

  <div class="stage">
    <canvas id="game"></canvas>
    <div class="overlay" id="overlay"><span class="msg" id="overlayText">READY!</span></div>
  </div>

  <a href="../index.html" class="back-btn">⟵ Back to Arcade</a>

  <script>
  // ======= CONFIG =======
  const tile = 28;
  const speedPac = 0.11;
  const speedGhost = 0.10;
  const speedFright = 0.08;
  const frightDuration = 6000;
  const scatterDur = 7000;
  const chaseDur   = 20000;
  const pelletScore = 10;
  const powerScore  = 50;
  const eatGhostScore = 200;

  // ======= SOUNDS (commented out to avoid 404s) =======
  /*
  const S = {
    waka:    tryAudio("https://thereelsho.github.io/10in1arcade/sounds/waka.wav", 0.35),
    power:   tryAudio("https://thereelsho.github.io/10in1arcade/sounds/power.wav", 0.45),
    eat:     tryAudio("https://thereelsho.github.io/10in1arcade/sounds/eatghost.wav", 0.5),
    death:   tryAudio("https://thereelsho.github.io/10in1arcade/sounds/death.wav", 0.6),
    intro:   tryAudio("https://thereelsho.github.io/10in1arcade/sounds/intro.wav", 0.7),
  };
  function tryAudio(url, vol=0.5){
    const a = new Audio(); a.src = url; a.preload = "auto"; a.volume = vol; return a;
  }
  function play(a){ if(!a) return; try{ a.currentTime=0; a.play(); }catch(e){} }
  */
  const S = {}; // empty, so play(S.xxx) won’t break

  // ======= CANVAS & HUD =======
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const highEl = document.getElementById('high');
  const livesEl = document.getElementById('lives');
  const overlayText = document.getElementById('overlayText');

  // ======= MAP =======
  const raw = [
    "1111111111111111111111111111",
    "1000000000001111000000000001",
    "1011110111111111111101111101",
    "1031110110001111000110111301",
    "1011110110111111110101111101",
    "1000000000110000001100000001",
    "1111111110110111101111111111",
    "2222221110100111001011122222",
    "1111111110101111101011111111",
    "1000000000100000001000000001",
    "1011110111110111011111011101",
    "1000000111005000111000000001",
    "1111110111011111101110111111",
    "2222220100000000000001022222",
    "1111110101111111111101011111",
    "1000000100111111111000100001",
    "1011110110111111110101111101",
    "1030000000001111000000000301",
    "1111111110110111101111111111",
    "1000000000110000001100000001",
    "1011110111111111111101111101",
    "1000000100001111000010000001",
    "1111110101111111110101111111",
    "2222220101000000001010122222",
    "1111110111011111101110111111",
    "1000000000001111000000000001",
    "1011111111111111111111111101",
    "1000000000000000000000000001",
    "1111111111111111111111111111"
  ].map(r=>r.split("").map(ch => {
    if(ch==="2") return 2;
    if(ch==="5") return 5;
    return +ch;
  }));

  const ROWS = raw.length, COLS = raw[0].length;
  canvas.width = COLS * tile;
  canvas.height = ROWS * tile;

  // ======= STATE =======
  let score = 0;
  let high = parseInt(localStorage.pacmanHigh || '0');
  highEl.textContent = high;
  let lives = 3;
  let mode = 'ready';
  let level = 1;
  let modeTimer = 0;
  let inScatter = true;

  const pac = { x: 14, y: 23, dx: 0, dy: 0, nextDir: null, speed: speedPac, mouth: 0, open: true };

  const corners = {
    blinky: {x: COLS-3, y: 1},
    pinky:  {x: 2, y: 1},
    inky:   {x: COLS-3, y: ROWS-2},
    clyde:  {x: 2, y: ROWS-2},
  };

  function makeGhost(name, x,y, color){
    return { name, x, y, dx:0, dy:0, color, edible:false, eyes:false, speed:speedGhost, scatterTarget: corners[name] };
  }

  let ghosts=[];
  resetEntities();

  // ======= INPUT =======
  document.addEventListener("keydown", e => {
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
    if(mode==="ready"){ /* play(S.intro); */ setTimeout(startRound,1500); return; }
    if(mode!=="play" && mode!=="fright") return;
    if(e.key==="ArrowUp")    pac.nextDir={dx:0,dy:-1};
    if(e.key==="ArrowDown")  pac.nextDir={dx:0,dy:1};
    if(e.key==="ArrowLeft")  pac.nextDir={dx:-1,dy:0};
    if(e.key==="ArrowRight") pac.nextDir={dx:1,dy:0};
  });

  // ======= HELPERS =======
  function isWall(x,y){ return y<0||y>=ROWS||x<0||x>=COLS||raw[y][x]===1; }
  function isGate(x,y){ return raw[y] && raw[y][x]===5; }
  function centerOf(x,y){ return {cx: x*tile+tile/2, cy: y*tile+tile/2}; }
  function gridAlign(v){ return Math.abs(v-Math.round(v))<0.01; }

  function resetEntities(){
    pac.x=14; pac.y=23; pac.dx=0; pac.dy=0; pac.nextDir=null;
    ghosts=[
      makeGhost("blinky",14,11,"red"),
      makeGhost("pinky",13,12,"pink"),
      makeGhost("inky",14,12,"cyan"),
      makeGhost("clyde",15,12,"orange")
    ];
  }

  function startRound(){ mode='play'; overlayText.textContent=''; modeTimer = performance.now(); inScatter = true; }
    // ======= DRAW =======
function drawMaze(){
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const v=raw[y][x];
      if(v===1){
        // wall
        ctx.fillStyle = "#0b21ff";
        ctx.fillRect(x*tile,y*tile,tile,tile);
        ctx.fillStyle = "rgba(255,255,255,0.08)";
        ctx.fillRect(x*tile,y*tile,tile,3);
        ctx.fillRect(x*tile,y*tile,3,tile);
      }else if(v===0){
        // pellet
        ctx.fillStyle="#fff";
        ctx.beginPath(); ctx.arc(x*tile+tile/2,y*tile+tile/2,3,0,Math.PI*2); ctx.fill();
      }else if(v===3){
        // power pellet
        ctx.fillStyle="#ff0";
        ctx.beginPath(); ctx.arc(x*tile+tile/2,y*tile+tile/2,6,0,Math.PI*2); ctx.fill();
      }else if(v===5){
        // gate
        ctx.fillStyle="#fff";
        ctx.fillRect(x*tile+4,y*tile+tile/2-1,tile-8,2);
      }
    }
  }
}

function drawPac(){
  const {cx,cy} = centerOf(pac.x, pac.y);
  const ang = Math.atan2(pac.dy,pac.dx) || 0;
  const m = pac.mouth;
  ctx.fillStyle="yellow";
  ctx.beginPath();
  ctx.arc(cx,cy,tile/2-2, ang+m, ang+2*Math.PI-m);
  ctx.lineTo(cx,cy); ctx.fill();
}

function drawGhost(g){
  const {cx,cy} = centerOf(g.x,g.y);
  ctx.fillStyle = g.eyes ? "#fff" : (g.edible ? "blue" : g.color);
  ctx.beginPath();
  ctx.arc(cx, cy, tile/2-2, Math.PI, 0);
  ctx.lineTo(cx+tile/2-2, cy+tile/2-2);
  ctx.lineTo(cx-tile/2+2, cy+tile/2-2);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#fff";
  if(g.eyes){
    ctx.beginPath(); ctx.arc(cx-5,cy,5,0,Math.PI*2);
    ctx.arc(cx+5,cy,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#000";
    ctx.beginPath(); ctx.arc(cx-5,cy,2,0,Math.PI*2);
    ctx.arc(cx+5,cy,2,0,Math.PI*2); ctx.fill();
  }else{
    const ex = (pac.x - g.x), ey = (pac.y - g.y);
    const len = Math.hypot(ex,ey)||1, ox = (ex/len)*3, oy=(ey/len)*3;
    ctx.beginPath(); ctx.arc(cx-5,cy,5,0,Math.PI*2); ctx.arc(cx+5,cy,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#000";
    ctx.beginPath(); ctx.arc(cx-5+ox,cy+oy,2,0,Math.PI*2); ctx.arc(cx+5+ox,cy+oy,2,0,Math.PI*2); ctx.fill();
  }
}


  // ======= MAIN LOOP =======
  let lastTs = performance.now();
  function frame(ts){
    const dt = Math.min(20, ts - lastTs);
    lastTs = ts;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawMaze();

    if(mode==='ready'){
      overlayText.textContent = 'READY! (Press Arrow)';
    } else if(mode==='play' || mode==='fright'){
      updatePac(dt);

      if(mode==='play'){
        const elapsed = ts - modeTimer;
        if(inScatter && elapsed > scatterDur){ inScatter = false; modeTimer = ts; }
        else if(!inScatter && elapsed > chaseDur){ inScatter = true; modeTimer = ts; }
      }

      ghosts.forEach(g => updateGhost(g, dt));
      handleCollisions();
    }

    ghosts.forEach(g => drawGhost(g));
    drawPac();

    highEl.textContent = Math.max(high, score);

    requestAnimationFrame(frame);
  }

  livesEl.textContent = lives;
  scoreEl.textContent = score;
  overlayText.textContent = 'READY! (Press Arrow)';
  requestAnimationFrame(frame);
  </script>
</body>
</html>
